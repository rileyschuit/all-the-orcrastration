---
- name: Install ssm, requires input
  hosts: all
  remote_user: "{{ remote_user | default('pi') }}"
  gather_facts: True

  # vars_prompt:
  #   - name: ssm_id
  #     prompt: "What is the Hybrid SSM ID?"
  #     private: no
  #     when: ssm_id is not defined
  #
  #   - name: code_id
  #     prompt: "What is the Hybrid SSM code?"
  #     private: no
  #     when: code_id is not defined
  #
  #   - name: ssm_region
  #     prompt: "What is the region we will be managing the machine from?"
  #     private: no
  #     when: ssm_region is not defined

  tasks:
    - name: populate service facts
      service_facts:

    - name: debug
      debug:
        msg: "{{ ansible_facts.services['amazon-ssm-agent.service'] }}"
      become: True
      become_method: sudo

    - name: Install onto RPi
      block:
        - name: Check for default raspbian password
          debug:
            msg: "Raspian still has the default password!"
          when: ansible_ssh_pass == 'raspberry'

        - name: Install deb package
          apt:
            deb: https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/debian_arm/amazon-ssm-agent.deb

        - name: Stop service
          service:
            name: amazon-ssm-agent
            status: stopped

        - name: Register Machine as hybrid instance
          shell: amazon-ssm-agent -register -code '{{ code_id }}' -id '{{ ssm_id }}' -region '{{ ssm_region }}'

        - name: Start service
          service:
            name: amazon-ssm-agent
            status: started

      when:
        - ansible_facts.services['amazon-ssm-agent.service'] is not defined
        - '"Debian" in ansible_facts.os_family'
        - '"arm" in ansible_facts.architecture'

    - name: Install onto Debian 64 bit host
      block:
        - name: Install deb package
          apt:
            deb: https://s3.amazonaws.com/ec2-downloads-windows/SSMAgent/latest/debian_amd64/amazon-ssm-agent.deb
          become: True
          become_method: sudo

        - name: Stop service
          service:
            name: amazon-ssm-agent
            status: stopped

        - name: Register Machine as hybrid instance
          shell: amazon-ssm-agent -register -code '{{ code_id }}' -id '{{ ssm_id }}' -region '{{ ssm_region }}'

        - name: Start service
          service:
            name: amazon-ssm-agent
            status: started

      when:
        - ansible_facts.services['amazon-ssm-agent.service'] is not defined
        - '"Debian" in ansible_facts.os_family'
        - '"x86_64" in ansible_facts.architecture'

  # TODO: Windows
