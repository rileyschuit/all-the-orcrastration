---

- name: Create VPC
  ec2_vpc_net:
    name: "{{ item.name }}"
    cidr_block: "{{ item.cidr_block }}"
    region: "{{ item.region }}"
    tags: "{{ item.tags }}"
  register: create_vpc
  with_items: "{{ vpc }}"

- name: IGW Creation
  ec2_vpc_igw:
    vpc_id: "{{ item.vpc.id }}"
    state: present
    region: us-east-1
    resource_tags: "{{ item.item.tags }}"
  register: igw
  with_items: "{{ create_vpc.results }}"
  when:
    - item.item.igw

- name: set fact so subnet creation actually works
  set_fact:
    subnets_to_build: "{{ subnets_to_build }} + [
        {% for creation in create_vpc.results %}
          {% for subnet in creation.item.subnets %}
          {
            'vpc_id': '{{ creation.vpc.id }}',
            'az': '{{ subnet.az }}',
            'subnet': '{{ subnet.subnet }}',
            'region': '{{ creation.item.region }}',
            'tags': {{ creation.item.tags }}
            {% for gw in igw.results %}
              {% if creation.vpc.id == gw.vpc_id %}
                , 'igw': '{{ gw.gateway_id }}'
              {% endif %}
            {% endfor %}
          },
          {% endfor %}
        {% endfor %}
      ]"

- name: Subnet Creation
  ec2_vpc_subnet:
    state: present
    vpc_id: "{{ item.vpc_id }}"
    cidr: "{{ item.subnet }}"
    region: "{{ item.region }}"
    az: "{{ item.az }}"
    tags: "{{ item.tags }}"
  register: subnet_creation
  with_items: "{{ subnets_to_build }}"

# There is probably a better way to do this
- name: Creation relation of vpc to subnet ID relation for route creation
  set_fact:
    routes_to_build: "{{ routes_to_build }} + [
      {% for igw_detail in igw.results %}
        {
          'vpc': '{{ igw_detail.vpc_id }}',
          'region': '{{ igw_detail.item.item.region }}',
          'tags': {{ igw_detail.item.item.tags }},
          'igw': '{{ igw_detail.gateway_id }}',
          'subnets': [
            {% for subnet_details in subnet_creation.results %}
              '{{ subnet_details.subnet.id }}',
            {% endfor %}
          ]
        },
      {% endfor %}
    ]"

# TODO: Define this with vars
- name: Add subnets to routing table
  ec2_vpc_route_table:
    vpc_id: "{{ item.vpc }}"
    region: "{{ item.region }}"
    tags: "{{ item.tags }}"
    subnets: "{{ item.subnets }}"
    routes:
      - dest: 0.0.0.0/0
        gateway_id: "{{ item.igw }}"
  register: public_route_table
  with_items: "{{ routes_to_build }}"

- name: Security group - Stateful FW
  ec2_group:
    name: "{{ item.item.name }} Security Group"
    description: "{{ item.item.name }} Security group"
    vpc_id: "{{ item.vpc.id }}"
    region: "{{ item.item.region }}"
    tags: "{{ item.item.tags }}"
    rules: "{{ item.item.sec_group }}"
  with_items: "{{ create_vpc.results }}"
  register: security_group_creation
